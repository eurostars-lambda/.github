# Guide for building & running the development container

This guideline explains how to build the development container (which is based on Orbit) and run the RL environments for training & testing.

1) Install the *suggested* GPU drivers for Isaac Sim from the Nvidia website, docker, and nvidia-container-toolkit if not installed already.
2) Make sure you can run Isaac Sim in the WebRTC livestream mode after installing it according to [here](https://docs.omniverse.nvidia.com/isaacsim/latest/installation/install_container.html). Account for [this](https://forums.developer.nvidia.com/t/webrtc-streaming-does-not-work-on-orbit-scripts-with-isaac-sim-2023-1-1/289821/3) following bug and its solution.
3) Create a document in which you will put all the developlent related files/repos for the container. Let's say this folder is called documents_oo for this guide. Go inside this folder.
4) Clone the following repos to this folder: eurostars-lambda/[orbit, lambda-gym, lambda-rl, lambda-robots]. You can also pull eurostars-lambda/lambda-cv, but it is not necessary at this point as it runs independently. 
    - If you are planning to do development in these repos, it makes sense to create your branches at this point (e.g., lambda-aica and lambda-circuli-ion) according [this guideline](CROSS_INSTITUTIONAL_REPO_BRANCH_SYNC_GUIDE.md).
5) Check the [orbit docker container deployment guidelines] (https://isaac-orbit.github.io/orbit/source/deployment/docker.html) to learn how to use `container.sh`. We will use the same but using "sbtc" profile.
6) Run `/container.sh start sbtc` inside the `orbit/docker/` directory to build and start our docker container. The resulting container should be "orbit-sbtc".
7) Enter the orbit-sbtc container with `/container.sh enter sbtc` command. Run `runisaac.sh` bash script (under `/workspace/orbit/` of the container) to start the isaac-sim in WebRTC mode. The first time could take a while as it needs to cache files. Once you see the  "Isaac Sim Headless WebRTC App is loaded." message, it means Isaac Sim started, and you need to go to WebRTC link in your browswer (`http://<ip address>:8211/streaming/webrtc-client?server=<ip address>`,  use `localhost` for IP address if on the same pc, use a supported browser!). 
    - The default port is 8211 but you can set a custom port with the `-p` or `--port` option.
    - Please note that sometimes, a port other than the set port is used at this point, i.e., if that port is already occupied. In this case, search for "on port" words on the terminal, and it would tell you the correct port.  
    - If you have problems regarding the resolution of the stream, please check [this](https://forums.developer.nvidia.com/t/changing-the-display-resolution-of-the-webrtc-streaming-in-isaac-sim-2023-1-0/270110) first and later edit the `runisaac.sh` bash script accordingly.
9) Once you are in the Isaac Sim, copy the relevant usd files you have to `/Library/usd/` inside the Nucleus server (you need to start this from Omniverse launcher native app). 
    - Follow the folder structure I suggest here, or the ones on the scripts. When a file is not found when you run the scripts, you will need to correct either where the usd files are located or the path you use on your scripts.
    - If you need to copy/paste the usd files around, simply copy/pasting folders rarely works unfortunetly, for example, in cases where one file refers to another file in a spesific folder. Because the relative file paths are not updated, you can fix the paths yourself, but it takes a while. I do not know the status of the solution from Nvidia's side for this (but they were working on it). An ugly but rather robust solution is the "collect asset" option. Once you know that a file works correctly and you want to copy/paste it to a new location, collect the relevant usd file there and it will copy/paste all the dependencies inside this folder while adjusting the relative files paths. Of course, this will duplicate some files/folders, e.g., when you collect an robot which is linked elegantly to its gripper from another folder, there will be a new gripper folder inside the collected folder, and the original gripper folder wont be used by the collected asset.
10) To run the orbit environments sbtc created, you can close the isaac-sim gui (while the container is still running). Open the vscode and attach it to the container. Go to the `/workspace/orbit/` older and choose your python interpreter to be the one from the "orbit" conda environment. 
11) Understand the folder structure and the source files a bit.
12) You can go to `random_agent.py` inside `/standalone/lambda-rl/scripts` (which is the same one with /docs/ since mounted) and run it with the `Python: Current File` debug option. This should start the Isaac Sim in WebRTC, and you should see four environments of a robot, table, and Kona module. Robots would be doing random actions. If this script can run without errors or warnings, everything is looking good. If not, check the messages to see what is wrong. To close it, click the stop icon from the vscode. Choosing exit from the Isaac Sim menu creates some errors for me, but it also works.
12) Inside the `/standalone/lambda-rl/scripts/` path, there are training and testing scripts for the environments (default for sbtc-reach) using both rsl-rl and rl_games. They are not necessarily tuned, but to try, go to the train.py from rsl-rl and run the same way. If successful, the log files are created temporarily to the `/workspace/orbit/log` path, which you can monitor in real-time using Tensorboard (launch it from the correct log path from VScode directly). This training does not use GUI.
13) Once the training is over (or you stop it), you can run the play.py path instead. It live streams using WebRTC, similar to `random_agent.py` but using the last neural network model/checkpoint created.
14) You have two options to visualize the GUI. The first option is WebRTC streaming which is set as default. It is thorugh browser and fast, good for working remotely over internet. The second option is X11 forwarding. For this you need to set the `livestream=0` and `headless=False` (see `random_agent.py`), and also set your PC X11 settings correctly. Using X11, the GUI apps acts like a native app on your PC, but it requires faster internet to work reliably.
15) If there are changes you want to commit in the repos (e.g., lambda-gym), go to this folder outside of the container and do it there. The ssh files you use for GitHub are not mounted to the container.
16) The END :)

